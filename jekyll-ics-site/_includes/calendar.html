<div class="calendar-container">
  <div class="calendar-header">
    <h2>üìÖ Calendar Events</h2>
  </div>

  <div class="events-list" id="events-container">
    <!-- Events will be loaded here by JavaScript -->
    <div class="loading">Loading calendar events...</div>
  </div>
</div>

<script>
  // Function to parse ICS data
  function parseICS(icsContent) {
    const events = [];
    const lines = icsContent.split('\n');
    let currentEvent = null;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();

      if (line === 'BEGIN:VEVENT') {
        currentEvent = {};
      } else if (line === 'END:VEVENT' && currentEvent) {
        events.push(currentEvent);
        currentEvent = null;
      } else if (currentEvent) {
        const colonIndex = line.indexOf(':');
        if (colonIndex > 0) {
          const key = line.substring(0, colonIndex);
          const value = line.substring(colonIndex + 1);

          if (key.startsWith('DTSTART')) {
            currentEvent.start = parseICSDate(value);
          } else if (key.startsWith('DTEND')) {
            currentEvent.end = parseICSDate(value);
          } else if (key === 'SUMMARY') {
            currentEvent.summary = value;
          } else if (key === 'DESCRIPTION') {
            currentEvent.description = value.replace(/\\n/g, '\n');
          } else if (key === 'LOCATION') {
            currentEvent.location = value;
          }
        }
      }
    }

    return events;
  }

  // Parse ICS date format
  function parseICSDate(dateStr) {
    if (dateStr.length === 8) {
      // YYYYMMDD format
      return new Date(
        dateStr.substring(0, 4),
        parseInt(dateStr.substring(4, 6)) - 1,
        dateStr.substring(6, 8)
      );
    } else if (dateStr.length >= 15) {
      // YYYYMMDDTHHmmss format
      return new Date(
        dateStr.substring(0, 4),
        parseInt(dateStr.substring(4, 6)) - 1,
        dateStr.substring(6, 8),
        dateStr.substring(9, 11),
        dateStr.substring(11, 13),
        dateStr.substring(13, 15)
      );
    }
    return new Date(dateStr);
  }

  // Format date for display
  function formatDate(date) {
    const options = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    };
    return date.toLocaleDateString('en-US', options);
  }

  // Display events
  function displayEvents(events) {
    const container = document.getElementById('events-container');
    
    if (events.length === 0) {
      container.innerHTML = '<div class="no-events">No events found.</div>';
      return;
    }

    // Sort events by start date
    events.sort((a, b) => a.start - b.start);

    let html = '';
    events.forEach(event => {
      html += `
        <div class="event-card">
          <div class="event-date">
            <span class="event-day">${event.start.getDate()}</span>
            <span class="event-month">${event.start.toLocaleString('en-US', { month: 'short' })}</span>
          </div>
          <div class="event-details">
            <h3 class="event-title">${event.summary || 'Untitled Event'}</h3>
            <p class="event-time">
              <strong>Start:</strong> ${formatDate(event.start)}
            </p>
            ${event.end ? `<p class="event-time"><strong>End:</strong> ${formatDate(event.end)}</p>` : ''}
            ${event.location ? `<p class="event-location">üìç ${event.location}</p>` : ''}
            ${event.description ? `<p class="event-description">${event.description}</p>` : ''}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
  }

  // Load ICS files
  async function loadICSFiles() {
    try {
      const response = await fetch('/ics-files/sample.ics');
      const icsContent = await response.text();
      const events = parseICS(icsContent);
      displayEvents(events);
    } catch (error) {
      document.getElementById('events-container').innerHTML = 
        '<div class="error">Error loading calendar events. Please check if ICS files exist.</div>';
      console.error('Error loading ICS files:', error);
    }
  }

  // Load events when page loads
  document.addEventListener('DOMContentLoaded', loadICSFiles);
</script>